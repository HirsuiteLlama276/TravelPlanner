@page "/place"
@inject HttpClient Http
@using System.Net.Http.Json
@using Newtonsoft.Json.Linq
@using MudBlazor
@using System.Text.Json
<MudPopoverProvider></MudPopoverProvider>
<head>
    <style>
        .mud-autocomplete-input, .mud-list {
            background-color: white;
        }

        .mud-popover {
            z-index: 1500 !important;
        }

        .header-gradient {
            background: linear-gradient(180deg, rgba(36, 122, 218, 0.79) 0%, rgba(30, 188, 84, 0.79) 100%);
            text-align: center;
        }
    </style>
</head>
<script>
    function adjustDescriptionWidth() {
        var image = document.getElementById('selectedImage');
        var description = document.getElementById('selectedDescription');
        if (image && description) {
            description.style.maxWidth = image.clientWidth + 'px';
        }
    }
    window.onload = adjustDescriptionWidth;
    window.onresize = adjustDescriptionWidth;  
</script>

<PageTitle>Place</PageTitle>

<div class="header-gradient">
    <h1 style="color: white; padding: 20px 0;">Travel Planner</h1>
</div>

<MudGrid Spacing="1">
    <MudItem>
        <MudPaper class="rounded-3" Width="400px" Height="400px" Style="background-color: lightblue">
            <MudContainer MaxWidth="MaxWidth.Small">
                <MudStack Spacing="1" >
                    <MudText Typo="Typo.h1" Style="font-size:25px; font-weight:700; margin-top: 30px; 
                               text-align:center;">Wybierz cel podróży</MudText>
                    <MudAutocomplete T="string" Label="Country" Value="@Hotel"
                                     ValueChanged="@HotelValueChange"
                                     SearchFunc="@SearchForHotel" Variant="Variant.Filled"
                                     ResetValueOnEmptyText=true
                                     Style="background-color:white; margin-top: 40px;" />
                </MudStack>
            </MudContainer>
        </MudPaper>
    </MudItem>
    <MudItem xs="8">
        <MudPaper class="rounded-3" Height="100%" Style="background-color: lightblue;">
            <MudCardContent>
                <div style="width: 100%; height: 100%; position: relative; text-align: center;">
                    <div style="width: 100%; height: 100px; background: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(0,123,255,1) 100%);
                        text-align: center; display: flex; align-items: center;
                        justify-content: center; display: @(string.IsNullOrEmpty(selectedPlaceImageUrl) ? "flex" : "none");">
                        <p style="font-size: 24px; color: white;">Gdzie się zatrzymasz?</p>
                    </div>
                    @if (!string.IsNullOrEmpty(selectedPlaceImageUrl))
                    {
                        <div style="text-align: center;">
                            <div style="display: inline-block; max-width: 100%; overflow: hidden;">
                                <img src="@selectedPlaceImageUrl" id="selectedImage" alt="Selected Place" style="width: 100%; min-width:700px; height: auto; max-height: 500px; object-fit: contain;" onload="adjustDescriptionWidth()" />
                            </div>
                            <div id="selectedDescription" style="text-align: center; margin: 20px auto 0 auto; width: fit-content;">
                                <p style="word-wrap: break-word;">@selectedPlaceDescription</p>
                            </div>
                        </div>
                    }
                </div>
            </MudCardContent>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    public string Hotel = "";
    string selectedPlaceDescription = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. " +
    "Ut porta molestie lorem ac mattis. Nunc cursus quis nibh eget iaculis.";
    string selectedPlaceImageUrl="";
    private string[] hotelData = new string[5];

    private async Task<IEnumerable<string>> SearchForHotel(string searchText)
    {
        var client = new myHttpClient();
        hotelData = new string[5];
        if (searchText == "")
            return hotelData;
        
        var response = await client.SearchForHotel(searchText);
        if (response.IsSuccessStatusCode)
        {
            var jsonString = await response.Content.ReadFromJsonAsync<JsonDocument>();
            if (jsonString != null)
            {
                var rootPlaces = jsonString.RootElement.GetProperty("places");
                for (int i = 0; i < 5; i++)
                {
                    hotelData[i] = rootPlaces[i].GetProperty("displayName").GetProperty("text").ToString();
                    i++;
                }
            }
        }
        return hotelData;
    }

    private async void HotelValueChange(string newValue)
    {        
        Hotel = newValue;
        if (string.IsNullOrEmpty(newValue)) return;
        string photoName ="";
        var client = new myHttpClient();
        var response = await client.SearchForHotel(Hotel);
        if (response.IsSuccessStatusCode)
        {
            var jsonString = await response.Content.ReadFromJsonAsync<JsonDocument>();
            if (jsonString != null)
            {
                var rootPlaces = jsonString.RootElement.GetProperty("places");
                photoName = rootPlaces[0].GetProperty("photos")[0].GetProperty("name").ToString();
            }
        }

        client = new myHttpClient();
        var photoResponse = await client.SearchForHotelPhotos(photoName);
        if (photoResponse.IsSuccessStatusCode)
        {
            var photoResponseContent = await response.Content.ReadFromJsonAsync<JsonDocument>();
            if (photoResponseContent != null)
            {
                var photoUri = photoResponseContent.RootElement.GetProperty("photoUri").ToString();
                photoUri = selectedPlaceImageUrl;
                //var photoUri = JsonSerializer.Deserialize<HotelPhoto>(photoResponseContent);
            }
        }

        Console.WriteLine(selectedPlaceImageUrl);
    }
}
